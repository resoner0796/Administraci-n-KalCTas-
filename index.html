<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KalCTas Admin</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a2e">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="KalCTas Admin">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

    <audio id="notification-sound" src="notification.mp3" preload="auto"></audio>

    <div class="container">
        <div class="admin-nav">
            <button class="btn-icon" onclick="logout()" title="Cerrar Sesi√≥n">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path fill-rule="evenodd" d="M7.5 3.75A1.5 1.5 0 006 5.25v13.5a1.5 1.5 0 001.5 1.5h6a1.5 1.5 0 001.5-1.5V15a.75.75 0 011.5 0v3.75a3 3 0 01-3 3h-6a3 3 0 01-3-3V5.25a3 3 0 013-3h6a3 3 0 013 3V9A.75.75 0 0115 9V5.25a1.5 1.5 0 00-1.5-1.5h-6zm10.72 4.72a.75.75 0 011.06 0l3 3a.75.75 0 010 1.06l-3 3a.75.75 0 11-1.06-1.06l1.72-1.72H9a.75.75 0 010-1.5h10.94l-1.72-1.72a.75.75 0 010-1.06z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>

        <section id="login-screen" style="display: block;">
            <div class="logo-container"><img src="" class="logo logo-img" alt="KalCTas Logo"></div>
            <h2>Iniciar Sesi√≥n</h2>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Correo electr√≥nico" required>
                <input type="password" id="login-password" placeholder="Contrase√±a" required>
                <button type="submit">Entrar</button>
            </form>
        </section>

        <section id="main-menu" style="display: none;">
            <div class="logo-container"><img src="" class="logo logo-img" alt="KalCTas Logo"></div>
            <h2>Men√∫ Principal</h2>
            <div class="main-menu-buttons">
                <button onclick="showScreen('inventory-screen')">üì¶ Inventario de Productos</button>
                <button onclick="showScreen('raw-materials-screen')">üè∑Ô∏è Inventario de Insumos</button>
                <button onclick="showScreen('orders-screen')">üì¨ Pedidos de la Tienda</button>
                <button onclick="showScreen('manual-order-screen')">üìù Registrar Venta Manual</button>
                <button onclick="showScreen('sales-history-screen')">üí∞ Historial de Pedidos</button>
                <button onclick="showScreen('finance-screen')">üìà Administraci√≥n</button>
                <button onclick="showScreen('theme-screen')">üé® Tema de la P√°gina</button>
                <button onclick="showScreen('packaging-screen')">üß∏ Gestionar Empaques y Video</button>
                <button onclick="showScreen('sales-screen')">üìä Reporte de Ventas</button>
                <button onclick="showScreen('sales-report-table-screen')">üìÑ Reporte Detallado (Tabla)</button>
                <button id="install-app-button">üì≤ Instalar App</button>
            </div>
        </section>

        <section id="inventory-screen" style="display: none;">
            <h1>Inventario de Productos</h1>
            <div id="category-visibility-controls">
                <h2>Visibilidad de Categor√≠as</h2>
            </div>
            <button onclick="showScreen('add-product-screen')">Agregar Nuevo Producto</button>
            <div id="inventory-accordion"></div> 
            <button class="close-button" onclick="showScreen('main-menu')">Volver al Men√∫</button>
        </section>

        <section id="add-product-screen" style="display: none;">
            <h1>Agregar Nuevo Producto</h1>
            <form id="add-product-form">
                <input type="text" id="product-name" placeholder="Nombre del producto" required>
                <select id="product-category" required>
                    <option value="" disabled selected>Selecciona una categor√≠a</option>
                    <option value="KalCTas2-4">KalCTas 2/4</option>
                    <option value="KalCTas3-4">KalCTas 3/4</option>
                    <option value="KalCTasLargas">KalCTas Largas</option>
                </select>
                <label for="product-image-url" style="text-align: left; margin-top: 10px;">Ruta de la imagen:</label>
                <input type="text" id="product-image-url" placeholder="Ej: assets/KalCTas2-4/modelo.png" required>
                <input type="number" id="product-stock" placeholder="Inventario" required>
                <input type="number" id="product-price" placeholder="Precio" step="0.01" required>
                <button type="submit">Guardar Producto</button>
            </form>
            <button class="close-button" onclick="showScreen('inventory-screen')">Volver al Inventario</button>
        </section>

        <section id="manual-order-screen" style="display: none;">
            <h1>Registrar Venta Manual</h1>
            <form id="manual-order-form">
                <h3>Datos del Cliente</h3>
                <input type="text" id="manual-order-client" placeholder="Nombre del Cliente" required>
                <input type="tel" id="manual-order-phone" placeholder="Tel√©fono del Cliente (Opcional)">
                <select id="manual-order-channel" required>
                    <option value="" disabled selected>Seleccionar Canal de Venta</option>
                    <option value="Facebook">Facebook</option>
                    <option value="Venta Personal">Venta Personal</option>
                    <option value="Otro">Otro</option>
                </select>
                <hr style="width:100%; border-color:var(--border-color); margin-top: 15px;">

                <h3>Productos Vendidos</h3>
                <div id="manual-order-items"></div>
                <button type="button" class="btn" style="background-color: var(--status-blue);" onclick="addManualOrderLine()">+ Agregar Producto</button>
                <hr style="width:100%; border-color:var(--border-color); margin-top: 15px;">
                
                <h3>Detalles de Entrega</h3>
                <select id="manual-delivery-method" onchange="toggleManualDeliveryFields()">
                    <option value="punto-medio">Punto medio</option>
                    <option value="domicilio">Entrega a domicilio</option>
                </select>
        
                <div id="manual-home-delivery-fields" style="display:none; flex-direction: column; gap: 15px;">
                    <label for="manual-delivery-street">Calle y n√∫mero:</label>
                    <input type="text" id="manual-delivery-street">
                    <label for="manual-delivery-neighborhood">Colonia:</label>
                    <input type="text" id="manual-delivery-neighborhood">
                    <label for="manual-delivery-description">Descripci√≥n (opcional):</label>
                    <textarea id="manual-delivery-description" placeholder="Ej: Casa color azul, port√≥n negro..."></textarea>
                </div>
                
                <div id="manual-pickup-location-fields" style="display:flex; flex-direction: column; gap: 15px;">
                    <label for="manual-delivery-date">Fecha de entrega:</label>
                    <input type="date" id="manual-delivery-date" required>
                    <label for="manual-delivery-location">Lugar de entrega:</label>
                    <select id="manual-delivery-location" onchange="toggleOtherManualLocation()">
                        <option value="Mi tienda Jarachina">Mi tienda Jarachina</option>
                        <option value="La Portillo">La Portillo</option>
                        <option value="Perif√©rico">Perif√©rico</option>
                        <option value="Smart perif√©rico">Smart perif√©rico</option>
                        <option value="Soriana Hidalgo">Soriana Hidalgo</option>
                        <option value="HEB Morelos">HEB Morelos</option>
                        <option value="Otro">Otro</option>
                    </select>
                    <textarea id="manual-other-location-note" placeholder="Escribe el lugar de entrega (punto medio)" style="display:none;"></textarea>
                </div>
        
                <label for="manual-delivery-comments">Comentarios (opcional):</label>
                <textarea id="manual-delivery-comments" placeholder="Ej: Entregar en la entrada principal, tocar el claxon, etc."></textarea>
                <hr style="width:100%; border-color:var(--border-color); margin-top: 15px;">
        
                <label for="manual-order-total" style="text-align:left; font-weight: bold; font-size: 1.2em;">Monto Total de la Venta ($)</label>
                <input type="number" id="manual-order-total" placeholder="0.00" step="0.01" required readonly style="font-size: 1.2em; font-weight: bold; color: var(--status-green); background-color: transparent; border: none; padding-left: 0;">
                
                <button type="submit">Registrar Venta</button>
            </form>
            <button class="close-button" onclick="showScreen('main-menu')">Volver al Men√∫</button>
        </section>

        <section id="raw-materials-screen" style="display: none;">
            <h1>Inventario de Insumos</h1>
            <h2>Agregar/Editar Insumo</h2>
            <form id="add-raw-material-form">
                <input type="hidden" id="raw-material-id">
                <input type="text" id="raw-material-description" placeholder="Descripci√≥n (Ej: Etiquetas Halloween)" required>
                <input type="number" id="raw-material-quantity" placeholder="Cantidad" min="0" required>
                <button type="submit" id="add-raw-material-btn">Agregar Insumo</button>
                <button type="button" id="cancel-edit-raw-material-btn" class="close-button" style="display: none;" onclick="cancelEditRawMaterial()">Cancelar Edici√≥n</button>
            </form>
            <div class="table-container">
                <h2>Insumos Actuales</h2>
                <table id="raw-materials-table">
                    <thead><tr><th>Descripci√≥n</th><th>Cantidad</th><th>Acciones</th></tr></thead>
                    <tbody id="raw-materials-table-body"></tbody>
                </table>
            </div>
            <button class="close-button" onclick="showScreen('main-menu')">Volver al Men√∫</button>
        </section>
        
        <section id="orders-screen" style="display: none;">
            <h1>Pedidos de la Tienda</h1>
            <ul id="orders-list"></ul>
            <button class="close-button" onclick="showScreen('main-menu')">Volver al Men√∫</button>
        </section>

        <section id="sales-history-screen" style="display: none;">
            <h1>Historial de Pedidos</h1>
            <ul id="sales-history-list"></ul>
            <button class="close-button" onclick="showScreen('main-menu')">Volver al Men√∫</button>
        </section>
        
        <section id="movements-history-screen" style="display: none;">
            <h1>Historial de Movimientos</h1>
            <div class="filter-container">
                <select id="movement-filter-category" onchange="loadMovementsHistory()">
                    <option value="all">Todas las categor√≠as</option>
                </select>
            </div>
            <ul id="movements-list" class="card-list"></ul>
            <button class="close-button" onclick="showScreen('finance-screen')">Volver a Administraci√≥n</button>
        </section>

        <section id="finance-screen" style="display: none;">
            <h1>Administraci√≥n Financiera</h1>
            <div class="finance-panel">
                <div class="finance-card" onclick="showMovementsHistory('Ventas')"><h3>Ventas Totales</h3><p id="total-sales">$0.00</p></div>
                <div class="finance-card" onclick="showMovementsHistory('Gastos')"><h3>Gastos Totales</h3><p id="total-expenses">$0.00</p></div>
                <div class="finance-card" onclick="showMovementsHistory('Utilidad')"><h3>Utilidad Total</h3><p id="total-profit">$0.00</p></div>
                <div class="finance-card" onclick="showMovementsHistory('Capital')"><h3>Capital Acumulado</h3><p id="total-capital">$0.00</p></div>
                <div class="finance-card" onclick="showMovementsHistory('Utilidad Negocio')"><h3>Utilidad Negocio (50%)</h3><p id="total-profit-negocio">$0.00</p></div>
                <div class="finance-card" onclick="showMovementsHistory('Utilidad Socio', 'Ulises')"><h3>Utilidad Ulises (25%)</h3><p id="total-profit-ulises">$0.00</p></div>
                <div class="finance-card" onclick="showMovementsHistory('Utilidad Socio', 'Dariana')"><h3>Utilidad Dariana (25%)</h3><p id="total-profit-dariana">$0.00</p></div>
            </div>

            <h2>Configuraci√≥n de Costos</h2>
            <form id="cost-config-form">
                <label for="product-cost-input" style="text-align: left;">Costo por Producto ($)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="product-cost-input" placeholder="Ej: 42" step="0.01" required>
                    <button type="submit" style="width: 150px;">Guardar</button>
                </div>
            </form>

            <form id="shipping-cost-config-form" style="margin-bottom: 20px;">
                <label for="shipping-cost-input" style="text-align: left;">Costo de Env√≠o a Domicilio ($)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="shipping-cost-input" placeholder="Ej: 70" step="0.01" required>
                    <button type="submit" style="width: 150px;">Guardar</button>
                </div>
            </form>
            <hr style="width: 100%; border-color: rgba(255, 255, 255, 0.3);">

            <h2>Registrar Gasto General</h2>
            <form id="add-expense-form">
                <input type="number" id="expense-amount" placeholder="Monto del Gasto ($)" step="0.01" required>
                <select id="expense-concept" required><option value="">Selecciona un concepto</option></select>
                <textarea id="expense-note" placeholder="Nota adicional (opcional)"></textarea>
                <button type="submit">Registrar Gasto</button>
            </form>
            <button type="button" class="btn" style="background-color: #16a085; margin-top: -10px; margin-bottom: 20px; padding: 10px;" onclick="addNewExpenseConcept()">+ Agregar Nuevo Concepto</button>
            <hr style="width: 100%; border-color: rgba(255, 255, 255, 0.3);">
            <h2>Gesti√≥n</h2>
            <div class="main-menu-buttons">
                <button onclick="showScreen('supplies-screen')">Insumos (Gastos)</button>
                <button onclick="showScreen('restock-screen')">Re-Stock de Inventario</button>
                <button onclick="showScreen('movements-history-screen')">Historial de Movimientos üßæ</button>
            </div>
            <button class="close-button" onclick="showScreen('main-menu')">Volver al Men√∫</button>
        </section>

        <section id="supplies-screen" style="display: none;">
            <h1>Gesti√≥n de Insumos (Gastos)</h1>
            <h2>Registrar Insumo</h2>
            <form id="add-supply-form">
                <input type="text" id="supply-description" placeholder="Descripci√≥n del insumo" required>
                <input type="number" id="supply-quantity" placeholder="Cantidad" min="1" required>
                <input type="number" id="supply-cost" placeholder="Costo por unidad" step="0.01" min="0" required>
                <button type="submit">Registrar Insumo</button>
            </form>
            <div class="table-container">
                <h2>Insumos Registrados</h2>
                <table id="supplies-table">
                    <thead><tr><th>Descripci√≥n</th><th>Cantidad</th><th>Costo Total</th><th>Acciones</th></tr></thead>
                    <tbody id="supplies-table-body"></tbody>
                </table>
            </div>
            <button class="close-button" onclick="showScreen('finance-screen')">Volver a Administraci√≥n</button>
        </section>
        
        <section id="restock-screen" style="display: none;">
            <h1>Re-Stock de Inventario</h1>
            <h2>Registrar Pedido</h2>
            <form id="add-restock-form">
                <div id="restock-items"></div>
                <button type="button" class="btn" onclick="addRestockLine()">Agregar otro modelo</button>
                <div style="text-align: right; font-size: 1.2em; font-weight: bold; margin: 15px 0;">Costo de Env√≠o: <input type="number" id="shipping-cost" placeholder="0" step="0.01" value="0" style="width: 100px; text-align: right; font-size: 1em;"></div>
                <div style="text-align: right; font-size: 1.5em; font-weight: bold; margin: 15px 0;">Total: <span id="restock-total">$0.00</span></div>
                <button type="submit">Registrar Pedido de Re-Stock</button>
            </form>
            <hr style="width: 100%; border-color: rgba(255, 255, 255, 0.3);">
            <h2>Historial de Re-Stocks</h2>
            <ul id="restock-history-list" class="card-list"></ul>
            <button class="close-button" onclick="showScreen('finance-screen')">Volver a Administraci√≥n</button>
        </section>

        <section id="sales-screen" style="display: none;">
             <h1>Reporte de Ventas</h1>
            <div class="chart-container" style="position: relative; height:40vh; width:80vw; background: #fff; border-radius: 12px; padding: 10px;"><canvas id="sales-chart"></canvas></div>
            <h2>Detalle de Ventas</h2>
            <ul id="sales-list"></ul>
            <button class="close-button" onclick="showScreen('main-menu')">Volver al Men√∫</button>
        </section>

        <section id="theme-screen" style="display: none;">
            <h1>Gestionar Tema de la Tienda</h1>
            <p>Selecciona el tema que se mostrar√° p√∫blicamente en la tienda en l√≠nea.</p>
            <p style="margin-top: 15px;">Tema Actual: <strong id="current-theme-status">Cargando...</strong></p>
            <div class="theme-buttons">
                <button onclick="setTheme('default')">Default (Normal)</button>
                <button onclick="setTheme('halloween')" style="background-color: #f9a03f; color: #0d0221;">Halloween üéÉ</button>
                <button onclick="setTheme('christmas')" style="background-color: #d94545;">Navidad üéÖ</button>
            </div>
            
            <button class="close-button" onclick="showScreen('main-menu')">Volver al Men√∫</button>
        </section>

        <section id="packaging-screen" style="display: none;">
            <h1>Gestionar Empaques y Video</h1>
            
            <div id="video-management-controls">
                <h2>Gestionar Video de la Tienda</h2>
                <form id="add-video-form" style="margin-bottom: 20px;">
                    <input type="text" id="video-name" placeholder="Nombre del video (ej. Video Navidad)" required>
                    <input type="text" id="video-url" placeholder="Ruta del video (ej. video_navidad.mp4)" required>
                    <button type="submit">Agregar Video</button>
                </form>
                <div id="video-list"></div>
            </div>

            <div id="packaging-visibility-controls">
                <h2>Gestionar Empaques</h2>
                <form id="add-packaging-form" style="margin-bottom: 20px;">
                    <input type="text" id="packaging-name" placeholder="Nombre del Empaque (Ej: Frankie)" required>
                    <input type="text" id="packaging-image-url" placeholder="Ruta de la imagen (Ej: Frankie.jpg)" required>
                    <button type="submit">Agregar Empaque</button>
                </form>
                <div id="packaging-list"></div>
            </div>

            <button class="close-button" onclick="showScreen('main-menu')">Volver al Men√∫</button>
        </section>
        
        <section id="sales-report-table-screen" style="display: none;">
            <h1>Reporte Detallado de Ventas</h1>
            <button onclick="descargarReportePDF()" style="background-color: #e74c3c; margin-bottom: 15px;">
    üìÑ Descargar en PDF
</button>
            <div class="table-container">
                <table id="sales-report-table">
                    <thead>
                        <tr>
                            <th>Folio</th>
                            <th>Cliente</th>
                            <th>Canal</th>
                            <th>Fecha</th>
                            <th>Total Venta</th>
                            <th>Costo Capital</th>
                            <th>Gasto Env√≠o</th>
                            <th>Utilidad Total</th>
                            <th>Util. Negocio (50%)</th>
                            <th>Util. Ulises (25%)</th>
                            <th>Util. Dariana (25%)</th>
                        </tr>
                    </thead>
                    <tbody id="sales-report-table-body"></tbody>
                </table>
            </div>
            <button class="close-button" onclick="showScreen('main-menu')">Volver al Men√∫</button>
        </section>

        <div id="edit-modal" class="edit-modal">
            <div class="modal-content">
                <h2>Editar Producto</h2>
                <form id="edit-product-form" class="edit-modal-form">
                    <input type="hidden" id="edit-product-id">
                    <label for="edit-name">Nombre:</label>
                    <input type="text" id="edit-name" required>
                    <label for="edit-category">Categor√≠a:</label>
                    <select id="edit-category" required>
                        <option value="KalCTas2-4">KalCTas 2/4</option>
                        <option value="KalCTas3-4">KalCTas 3/4</option>
                        <option value="KalCTasLargas">KalCTas Largas</option>
                    </select>
                    <label for="edit-image-url">Cambiar URL de imagen (opcional):</label>
                    <input type="text" id="edit-image-url">
                    <label for="edit-stock">Stock:</label>
                    <input type="number" id="edit-stock" required>
                    <label for="edit-price">Precio:</label>
                    <input type="number" id="edit-price" step="0.01" required>
                    
                    <div style="display: flex; align-items: center; justify-content: start; margin: 15px 0 10px 0; text-align: left;">
                        <input type="checkbox" id="edit-visible" style="width: auto; height: auto; margin-right: 10px;">
                        <label for="edit-visible" style="margin: 0;">Visible en la tienda</label>
                    </div>
                    
                    <button type="submit">Guardar Cambios</button>
                </form>
                <button class="close-button" onclick="closeEditModal()">Cancelar</button>
            </div>
        </div>
        <div id="message-box" class="message-box">
            <div class="modal-content">
                <p id="message-text"></p>
                <button class="close-button" onclick="closeMessage()">Aceptar</button>
            </div>
        </div>
        <div id="confirm-modal" class="confirm-modal">
            <div class="modal-content">
                <p id="confirm-text">¬øEst√°s seguro?</p>
                <div class="confirm-buttons">
                    <button class="btn btn-yes" onclick="confirmAction()">S√≠</button>
                    <button class="btn btn-no" onclick="cancelAction()">Cancelar</button>
                </div>
            </div>
        </div>
        <div id="sales-history-modal" class="sales-history-modal">
            <div class="modal-content">
                <h2 id="modal-history-title">Historial</h2>
                <ul id="modal-sales-list" style="max-height: 400px; overflow-y: auto; text-align:left;"></ul>
                <button class="close-button" onclick="closeSalesHistoryModal()">Cerrar</button>
            </div>
        </div>
        <div id="image-modal" class="image-modal" onclick="cerrarModal()">
            <span class="close-modal">&times;</span>
            <img class="modal-content-img" id="modal-image">
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="js/app.js"></script>

</body>
</html>
